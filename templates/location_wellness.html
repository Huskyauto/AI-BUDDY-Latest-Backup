{% extends "base.html" %}

{% block head %}
<!-- Include Tone.js for audio synthesis -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.37/Tone.js"></script>

<!-- Google Maps initialization code must be defined before loading the API -->
<script>
    let map;
    let markers = [];

    function initMap() {
        try {
            console.log('Starting map initialization');
            const defaultLocation = { lat: 37.7749, lng: -122.4194 }; // Default to SF

            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultLocation,
                zoom: 14,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "on" }]
                    }
                ]
            });

            // Add loading indicator
            document.getElementById('places-list').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>Getting your location...
                </div>
            `;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        map.setCenter(userLocation);

                        // Add user marker
                        new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: 'Your Location',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#4285F4',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            }
                        });

                        // Search for nearby places
                        searchNearbyPlaces(userLocation);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        document.getElementById('places-list').innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Could not get your location. Please enable location services.
                            </div>
                        `;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
        } catch (error) {
            console.error('Error initializing map:', error);
            document.getElementById('map').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error initializing map: ${error.message}
                </div>
            `;
        }
    }

    // Handle API loading errors
    function gm_authFailure() {
        document.getElementById('map').innerHTML =
            '<div class="alert alert-danger">Google Maps authentication failed. Please check your API key.</div>';
    }
</script>

<!-- Load Google Maps API after initialization code is defined -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry&callback=initMap">
</script>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h1>Location Wellness</h1>
            <p class="text-muted">Get mindful eating suggestions when near food locations</p>

            <!-- Settings Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Settings</h5>
                    <div class="settings-content">
                        <div class="mb-3">
                            <label for="apiKeyInput" class="form-label">Google Maps API Key Status</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="apiKeyInput" value="••••••••" readonly>
                                <button class="btn btn-outline-secondary dropdown-toggle dropdown-clickable" type="button" id="settingsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-cog me-2"></i>Settings
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="settingsDropdown">
                                    <li><a class="dropdown-item dropdown-clickable" href="#" id="testApiKey">
                                        <i class="fas fa-vial me-2"></i>Test API Key
                                    </a></li>
                                </ul>
                            </div>
                            <div id="apiKeyStatus" class="form-text"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">API Test</h5>
                    <p class="text-muted">Test Places API detection with current location</p>
                    <button id="test-places-api" class="btn btn-info dropdown-clickable">
                        <i class="fas fa-vial me-2"></i>Test Places API
                    </button>
                    <div id="test-results" class="mt-3" style="display: none;">
                        <h6>Test Results:</h6>
                        <pre id="test-output" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>
            </div>

            <!-- Location Status Section -->
            <div class="card mt-4">
                <div class="card-body">
                    <!-- Speed and System Status Display -->
                    <div class="row mb-4">
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center py-3">
                                    <h6 class="text-muted mb-2"><i class="fas fa-tachometer-alt me-2"></i>Current Speed</h6>
                                    <span id="current-speed-display" class="badge bg-secondary fs-5">0.0 mph</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center py-3">
                                    <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>System</h6>
                                    <span id="system-armed-badge" class="badge bg-secondary fs-6">Standby</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Speed Thresholds Legend -->
                    <div class="alert alert-light mb-4">
                        <small>
                            <strong>Auto-Tracking Thresholds:</strong><br>
                            <span class="badge bg-primary me-2">10+ mph</span> System Arms (ready for alerts)<br>
                            <span class="badge bg-warning text-dark me-2">&lt;10 mph</span> Check for fast-food nearby<br>
                            <span class="badge bg-success me-2">15+ mph</span> Reset for next event
                        </small>
                    </div>
                    
                    <!-- Location Status Section -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-map-marker-alt text-primary"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">Location Status</h5>
                                <p class="text-muted mb-0">Last Update: <span id="location-last-update">Not Available</span></p>
                                <span id="location-status-active" class="badge bg-success" style="display: none;">Active</span>
                            </div>
                        </div>
                    </div>

                    <!-- System Status Display -->
                    <div id="system-status-display" class="alert alert-secondary mb-3">
                        <i class="fas fa-pause-circle me-2"></i>Standby - Speed up to 10+ mph to arm
                    </div>

                    <!-- Tracking Controls -->
                    <div class="d-grid gap-2">
                        <button id="start-location-tracking" class="btn btn-success dropdown-clickable">
                            <i class="fas fa-play me-2"></i>Start Location Tracking
                        </button>
                        <button id="stop-location-tracking" class="btn btn-danger dropdown-clickable" style="display: none;">
                            <i class="fas fa-stop me-2"></i>Stop Location Tracking
                        </button>
                        <button id="force-raising-canes-alert" class="btn btn-warning dropdown-clickable mt-2">
                            <i class="fas fa-bolt me-2"></i>Force Raising Cane's Alert (Test)
                        </button>
                    </div>

                    <!-- Active Tracking Message -->
                    <div id="tracking-active-message" class="alert alert-success mt-3" style="display: none;">
                        <i class="fas fa-check-circle me-2"></i>
                        <span>Location Tracking Active</span>
                        <p class="small mb-0">You'll receive mindful eating alerts when near food locations.</p>
                    </div>
                    
                    <!-- Alert Location Display -->
                    <div id="alert-location" class="mt-3"></div>
                </div>
            </div>

            <!-- Map Section -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Nearby Places</h5>
                    <div id="map" style="height: 400px; width: 100%; margin-bottom: 20px;"></div>
                    <div id="places-list" class="list-group">
                        <!-- Places will be populated here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Mindful Eating Suggestions -->
            <div id="mindful-eating-suggestions" class="card mt-4" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">Mindful Eating Suggestions</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">• Take a moment to check your hunger level (1-10)</li>
                        <li class="mb-2">• Consider if you're eating from physical hunger or emotional needs</li>
                        <li class="mb-2">• Remember your health goals and values</li>
                        <li class="mb-2">• Think about how you'll feel after eating - will it align with your goals?</li>
                        <li class="mb-2">• Practice mindful eating by taking smaller bites and eating slowly</li>
                        <li class="mb-2">• Listen to your body's natural hunger and fullness signals</li>
                        <li class="mb-2">• Consider going for a short walk or drinking water first</li>
                        <li class="mb-2">• Remember that every meal is an opportunity to nourish your body</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Google Maps JavaScript API with geometry library -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry"></script>
<script src="{{ url_for('static', filename='js/location_wellness.js') }}"></script>
{% endblock %}