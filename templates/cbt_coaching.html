{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h4 mb-0">CBT (Cognitive Behavioral Therapy) Coaching</h2>
                <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-primary no-auto-scroll">Back to Dashboard</a>
            </div>
            <script>
                // Explicitly disable auto-scrolling when returning to dashboard
                document.addEventListener('DOMContentLoaded', function() {
                    const dashboardLinks = document.querySelectorAll('a[href*="dashboard"]');
                    dashboardLinks.forEach(link => {
                        link.addEventListener('click', function(e) {
                            // Store a flag to prevent auto-scrolling
                            sessionStorage.setItem('preventAutoScroll', 'true');
                            // Make sure history doesn't auto-restore scroll position
                            if ('scrollRestoration' in history) {
                                history.scrollRestoration = 'manual';
                            }
                        });
                    });
                });
            </script>
            <p class="text-muted mb-4">
                Personalized cognitive behavioral therapy insights and exercises based on your mood patterns and activities.
                Click on each section to learn more about different CBT techniques and practices. Hover over insights for more detailed explanations.
            </p>

            {% if error %}
            <div class="alert alert-warning">{{ error }}</div>
            {% endif %}

            <div class="accordion" id="cbtAccordion">
                <!-- Cognitive Patterns Section -->
                <div class="accordion-item">
                    <h3 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#thoughtPatterns">
                            Cognitive Patterns Identified
                        </button>
                    </h3>
                    <div id="thoughtPatterns" class="accordion-collapse collapse show" data-bs-parent="#cbtAccordion">
                        <div class="accordion-body">
                            <ul class="list-unstyled">
                                {% for pattern in insights.mood_patterns.patterns %}
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="{{ pattern.detail }}"
                                          class="insight-item">
                                        <i class="fas fa-lightbulb text-primary me-2"></i>
                                        {{ pattern.summary }}
                                    </span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Behavioral Insights Section -->
                <div class="accordion-item">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#behavioral">
                            Behavioral Insights
                        </button>
                    </h3>
                    <div id="behavioral" class="accordion-collapse collapse" data-bs-parent="#cbtAccordion">
                        <div class="accordion-body">
                            <ul class="list-unstyled">
                                {% for pattern in insights.food_insights.patterns %}
                                <li class="mb-3">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-circle text-primary me-2 mt-2"></i>
                                        <span data-bs-toggle="popover" 
                                              data-bs-trigger="hover focus"
                                              data-bs-content="{{ pattern.detail }}"
                                              data-bs-placement="right"
                                              class="insight-item">
                                            {{ pattern.summary }}
                                        </span>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- CBT Exercises Section -->
                <div class="accordion-item">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#exercises">
                            CBT Exercises
                        </button>
                    </h3>
                    <div id="exercises" class="accordion-collapse collapse" data-bs-parent="#cbtAccordion">
                        <div class="accordion-body">
                            <ul class="list-unstyled">
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Write down automatic thoughts when you notice mood changes. Challenge each thought by examining the evidence for and against it."
                                          class="insight-item">
                                        <i class="fas fa-pencil-alt text-primary me-2"></i>
                                        Thought Record Exercise
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Rate your mood before and after activities. This helps identify which activities improve your mood and which might be triggering negative emotions."
                                          class="insight-item">
                                        <i class="fas fa-chart-line text-success me-2"></i>
                                        Activity Mood Tracking
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Practice identifying cognitive distortions in your thoughts. Common ones include all-or-nothing thinking, catastrophizing, and overgeneralization."
                                          class="insight-item">
                                        <i class="fas fa-brain text-warning me-2"></i>
                                        Cognitive Distortion Identification
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Set small, achievable goals and track your progress. Break larger goals into manageable steps and celebrate small victories."
                                          class="insight-item">
                                        <i class="fas fa-bullseye text-info me-2"></i>
                                        Behavioral Activation Planning
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Mindful Eating Section -->
                <div class="accordion-item">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mindfulEating">
                            Mindful Eating Practices
                        </button>
                    </h3>
                    <div id="mindfulEating" class="accordion-collapse collapse" data-bs-parent="#cbtAccordion">
                        <div class="accordion-body">
                            <ul class="list-unstyled">
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Take time to observe the colors, textures, and smells of your food before eating. This enhances awareness and satisfaction."
                                          class="insight-item">
                                        <i class="fas fa-eye text-primary me-2"></i>
                                        Sensory Awareness Practice
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Pay attention to your hunger and fullness cues. Rate your hunger on a scale of 1-10 before, during, and after eating."
                                          class="insight-item">
                                        <i class="fas fa-balance-scale text-success me-2"></i>
                                        Hunger-Fullness Monitoring
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Notice emotional triggers for eating and practice alternative coping strategies when not physically hungry."
                                          class="insight-item">
                                        <i class="fas fa-heart text-danger me-2"></i>
                                        Emotional Eating Awareness
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Create a calm eating environment without distractions. Put away phones and turn off TV to focus on the eating experience."
                                          class="insight-item">
                                        <i class="fas fa-peace text-info me-2"></i>
                                        Distraction-Free Dining
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Cognitive Reframing Section -->
                <div class="accordion-item">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#reframing">
                            Cognitive Reframing Examples
                        </button>
                    </h3>
                    <div id="reframing" class="accordion-collapse collapse" data-bs-parent="#cbtAccordion">
                        <div class="accordion-body">
                            <ul class="list-unstyled">
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Instead of 'I always fail,' try 'I'm learning from this experience and can improve next time.'"
                                          class="insight-item">
                                        <i class="fas fa-sync text-primary me-2"></i>
                                        All-or-Nothing Thinking
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Replace 'This is terrible' with 'This is challenging but manageable.'"
                                          class="insight-item">
                                        <i class="fas fa-mountain text-warning me-2"></i>
                                        Catastrophizing
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Instead of 'I should be perfect,' try 'I'm doing my best and that's good enough.'"
                                          class="insight-item">
                                        <i class="fas fa-star text-success me-2"></i>
                                        Should Statements
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Replace 'Everyone thinks I'm incompetent' with 'Some tasks are challenging, but that doesn't define my overall abilities.'"
                                          class="insight-item">
                                        <i class="fas fa-users text-info me-2"></i>
                                        Mind Reading
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Next Steps Section -->
                <div class="accordion-item">
                    <h3 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nextSteps">
                            Next Steps
                        </button>
                    </h3>
                    <div id="nextSteps" class="accordion-collapse collapse" data-bs-parent="#cbtAccordion">
                        <div class="accordion-body">
                            <ul class="list-unstyled">
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Start by focusing on one pattern at a time. Choose a pattern that feels most relevant to your current situation."
                                          class="insight-item">
                                        <i class="fas fa-arrow-right text-primary me-2"></i>
                                        Select a focus area
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Set a specific, achievable goal related to your chosen pattern. For example, practicing mindful eating during one meal per day."
                                          class="insight-item">
                                        <i class="fas fa-bullseye text-success me-2"></i>
                                        Set a concrete goal
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Track your progress daily using the mood and food logging features. This helps identify what's working and what needs adjustment."
                                          class="insight-item">
                                        <i class="fas fa-chart-line text-info me-2"></i>
                                        Monitor your progress
                                    </span>
                                </li>
                                <li class="mb-3">
                                    <span data-bs-toggle="popover" 
                                          data-bs-trigger="hover focus"
                                          data-bs-content="Schedule regular check-ins to review your progress and adjust your approach as needed."
                                          class="insight-item">
                                        <i class="fas fa-calendar-check text-warning me-2"></i>
                                        Plan regular reviews
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Track scroll position to prevent unwanted scrolling
    let lastScrollPosition = 0;
    
    // Save scroll position before any accordion interaction
    let accordionButtons = document.querySelectorAll('.accordion-button');
    accordionButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            // Store scroll position before accordion changes
            lastScrollPosition = window.scrollY || document.documentElement.scrollTop;
            console.log('Saving scroll position before accordion action:', lastScrollPosition);
            
            // If global ScrollManager exists, use it
            if (window.ScrollManager) {
                window.ScrollManager.saveScrollPosition();
            }
        });
    });
    
    // Restore scroll position after accordion transition completes
    let accordionItems = document.querySelectorAll('.accordion-collapse');
    accordionItems.forEach(function(item) {
        // When an accordion opens
        item.addEventListener('shown.bs.collapse', function() {
            setTimeout(function() {
                // Restore position (prefer ScrollManager if available)
                if (window.ScrollManager) {
                    window.ScrollManager.restoreScrollPosition();
                } else {
                    window.scrollTo({
                        top: lastScrollPosition,
                        behavior: 'auto'
                    });
                }
                console.log('Restored scroll position after accordion open:', lastScrollPosition);
            }, 50);
        });
        
        // When an accordion closes
        item.addEventListener('hidden.bs.collapse', function() {
            setTimeout(function() {
                // Restore position (prefer ScrollManager if available)
                if (window.ScrollManager) {
                    window.ScrollManager.restoreScrollPosition();
                } else {
                    window.scrollTo({
                        top: lastScrollPosition,
                        behavior: 'auto'
                    });
                }
                console.log('Restored scroll position after accordion close:', lastScrollPosition);
            }, 50);
        });
    });
    
    // Initialize all popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            html: true,
            placement: 'auto'
        });
    });

    // Cleanup popovers when accordion sections are collapsed
    document.addEventListener('hidden.bs.collapse', function(e) {
        popoverList.forEach(function(popover) {
            popover.hide();
        });
    });
});
</script>

<style>
.insight-item {
    cursor: help;
    border-bottom: 1px dotted #666;
    display: inline-block;
    padding: 2px 0;
    margin-left: 4px;
}

.insight-item:hover {
    color: #0d6efd;
    text-decoration: none;
}

.fas.fa-circle {
    font-size: 6px;
    margin-top: 8px;
}

.list-unstyled li {
    position: relative;
    margin-bottom: 1rem;
}

.popover {
    max-width: 300px;
}
</style>
{% endblock %}