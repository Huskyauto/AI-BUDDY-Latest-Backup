{% extends "base.html" %}

{% block title %}Meditation Challenges{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="text-center mb-4">Meditation Challenges</h1>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    <!-- Create Challenge Button (Modal Trigger) -->
    <div class="text-end mb-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createChallengeModal">
            Create Challenge
        </button>
    </div>

    <!-- Active Challenges Section -->
    <section class="mb-5">
        <h2>Active Challenges</h2>
        <div class="row g-4">
            {% for challenge in active_challenges %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">{{ challenge.name }}</h5>
                        <p class="card-text">{{ challenge.description }}</p>
                        <div class="mb-2">
                            <small class="text-muted">
                                Duration: {{ challenge.duration_requirement }} minutes/day
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                Participants: {{ challenge.current_participants }}/
                                {% if challenge.max_participants %}
                                    {{ challenge.max_participants }}
                                {% else %}
                                    âˆž
                                {% endif %}
                            </small>
                        </div>
                        {% if current_user not in challenge.participants %}
                        <button class="btn btn-primary join-challenge" data-challenge-id="{{ challenge.id }}">
                            Join Challenge
                        </button>
                        {% else %}
                        <button class="btn btn-success" disabled>
                            Participating
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col">
                <p class="text-muted">No active challenges at the moment.</p>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Upcoming Challenges Section -->
    <section>
        <h2>Upcoming Challenges</h2>
        <div class="row g-4">
            {% for challenge in upcoming_challenges %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">{{ challenge.name }}</h5>
                        <p class="card-text">{{ challenge.description }}</p>
                        <div class="mb-2">
                            <small class="text-muted">
                                Starts: {{ challenge.start_date.strftime('%Y-%m-%d') }}
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                Duration: {{ challenge.duration_requirement }} minutes/day
                            </small>
                        </div>
                        {% if challenge.can_join(current_user) %}
                        <button class="btn btn-outline-primary join-challenge" data-challenge-id="{{ challenge.id }}">
                            Join Challenge
                        </button>
                        {% else %}
                        <button class="btn btn-outline-secondary" disabled>
                            Registration Closed
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col">
                <p class="text-muted">No upcoming challenges at the moment.</p>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Create Challenge Modal -->
    <div class="modal fade" id="createChallengeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Challenge</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createChallengeForm">
                        <div class="mb-3">
                            <label class="form-label">Challenge Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Daily Meditation Duration (minutes)</label>
                            <input type="number" class="form-control" name="duration_requirement" value="10" min="5">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Weekly Frequency</label>
                            <input type="number" class="form-control" name="frequency_requirement" value="1" min="1" max="7">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Maximum Participants (optional)</label>
                            <input type="number" class="form-control" name="max_participants" min="2">
                        </div>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" name="is_public" checked>
                            <label class="form-check-label">Public Challenge</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createChallengeBtn">Create Challenge</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Challenge Chat Modal -->
<div class="modal fade" id="challengeChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Challenge Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="chatMessages" class="mb-3" style="height: 300px; overflow-y: auto;">
                    <!-- Messages will be inserted here -->
                </div>
                <form id="chatForm" class="d-flex">
                    <input type="text" class="form-control me-2" id="messageInput" placeholder="Type your message...">
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle challenge creation
        const createChallengeBtn = document.getElementById('createChallengeBtn');
        const createChallengeForm = document.getElementById('createChallengeForm');

        createChallengeBtn.addEventListener('click', async function() {
            const formData = new FormData(createChallengeForm);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/challenges/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    location.reload();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error creating challenge:', error);
                alert('Error creating challenge');
            }
        });

        // Handle joining challenges
        document.querySelectorAll('.join-challenge').forEach(button => {
            button.addEventListener('click', async function() {
                const challengeId = this.dataset.challengeId;

                try {
                    const response = await fetch(`/api/challenges/join/${challengeId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        location.reload();
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('Error joining challenge:', error);
                    alert('Error joining challenge');
                }
            });
        });

        // Handle chat functionality
        let currentChallengeId = null;
        const chatForm = document.getElementById('chatForm');
        const chatMessages = document.getElementById('chatMessages');

        async function loadChatMessages(challengeId) {
            try {
                const response = await fetch(`/api/challenges/${challengeId}/messages`);
                const result = await response.json();

                if (result.status === 'success') {
                    chatMessages.innerHTML = result.messages.map(msg => `
                        <div class="mb-2">
                            <strong>${msg.user}</strong>
                            <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
                            <p class="mb-1">${msg.message}</p>
                        </div>
                    `).join('');

                    // Removed auto-scroll for challenge chat
                    // chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            try {
                const response = await fetch(`/api/challenges/${currentChallengeId}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    messageInput.value = '';
                    await loadChatMessages(currentChallengeId);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message');
            }
        });
    });
</script>
{% endblock %}