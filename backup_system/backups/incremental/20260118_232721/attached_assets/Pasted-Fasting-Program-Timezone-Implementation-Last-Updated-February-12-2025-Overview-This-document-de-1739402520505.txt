Fasting Program Timezone Implementation
Last Updated: February 12, 2025
Overview
This document details the implementation of local timezone support in the AI-BUDDY fasting program, focusing on how timestamps and date calculations are handled to ensure accurate tracking of fasting sessions and check-ins.
Core Implementation
Timezone Utility Functions
The fasting program relies on two core timezone functions from models.py:
def get_local_time():
    """Get current time in local timezone"""
    local_tz = ZoneInfo('America/Los_Angeles')  # Using Pacific Time as default
    return datetime.now(local_tz)
 
def format_timestamp(timestamp):
    """Format timestamp to local timezone"""
    if timestamp is None:
        return None
    if timestamp.tzinfo is None:
        timestamp = timestamp.replace(tzinfo=timezone.utc)
    local_tz = ZoneInfo('America/Los_Angeles')
    return timestamp.astimezone(local_tz)
Database Schema Configuration
The fasting models use timezone-aware DateTime columns:
class FastingSession(db.Model):
    start_date = db.Column(db.DateTime(timezone=True), nullable=False, default=get_local_time)
    end_date = db.Column(db.DateTime(timezone=True))
    # ...
 
class FastingCheckIn(db.Model):
    check_in_time = db.Column(db.DateTime(timezone=True), default=get_local_time)
    # ...
Implementation Details
1. Starting a Fasting Session
When a user starts a new fasting session:
current_time = get_local_time()
session = FastingSession(
    user_id=current_user.id,
    program_id=program_id,
    start_date=current_time,
    status='active'
)
The response includes properly formatted local timestamps:
return jsonify({
    'status': 'success',
    'session_id': session.id,
    'start_time': format_timestamp(session.start_date).isoformat()
})
2. Tracking Active Sessions
For active session tracking:
# Calculate days elapsed using timezone-aware timestamps
current_time = get_local_time()
days_elapsed = (current_time - session.start_date).days
current_day = days_elapsed + 1 if days_elapsed >= 0 else 1
3. Daily Check-ins
Check-ins are recorded with local timezone awareness:
check_in = FastingCheckIn(
    session_id=session.id,
    day_number=current_day,
    check_in_time=get_local_time(),
    # ...
)
Key Features
1.	Timezone-Aware Calculations
•	All date/time calculations consider timezone information
•	Day transitions are based on local time, not UTC
•	Check-in times reflect the user's local timezone
2.	Consistent Timestamp Handling
•	All timestamps are stored with timezone information
•	Times are converted to local timezone before display
•	ISO format used for JSON responses
3.	Automatic Timezone Conversion
•	Database stores timestamps in UTC
•	Automatic conversion to local time when retrieving data
•	Proper handling of DST transitions
Examples
Session Duration Calculation
# Calculate fasting duration in local timezone
current_time = get_local_time()
duration = (current_time - session.start_date).days
Check-in Time Display
check_ins = [{
    'day_number': c.day_number,
    'check_in_time': format_timestamp(c.check_in_time).isoformat(),
    # ...
} for c in session.check_ins]
Best Practices
1.	Always Use Timezone-Aware DateTime Columns
db.Column(db.DateTime(timezone=True), default=get_local_time)
2.	Convert Timestamps Before Display
•	Always use format_timestamp() before sending to frontend
•	Include timezone information in ISO format strings
3.	Local Time for New Records
•	Use get_local_time() for current timestamps
•	Avoid using datetime.now() without timezone
4.	Consistent Format for API Responses
•	Always return ISO formatted strings
•	Include timezone information in timestamps
Common Issues and Solutions
1.	UTC vs Local Time Display
•	Problem: Timestamps showing in UTC instead of local time
•	Solution: Use format_timestamp() before converting to ISO format
2.	Day Calculation Issues
•	Problem: Incorrect day counting due to timezone differences
•	Solution: Use timezone-aware timestamps in calculations
3.	Check-in Time Accuracy
•	Problem: Check-ins recorded in wrong timezone
•	Solution: Use get_local_time() for all new records
Future Improvements
1.	Add user-configurable timezone preferences
2.	Implement timezone selection in user settings
3.	Add timezone display in UI for clarity
4.	Support for multiple timezone formats in exports
Dependencies
•	Python's zoneinfo module
•	SQLAlchemy with timezone support
•	Flask-SQLAlchemy
