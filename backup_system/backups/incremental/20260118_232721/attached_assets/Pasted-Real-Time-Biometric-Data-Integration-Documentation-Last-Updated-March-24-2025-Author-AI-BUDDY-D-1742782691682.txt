Real-Time Biometric Data Integration Documentation
Last Updated: March 24, 2025
Author: AI-BUDDY Development Team

Overview
This document provides detailed information about the real-time biometric data integration in the AI-BUDDY health application. The implementation enables seamless connection to Oura Ring and Ultrahuman Ring APIs to fetch and analyze authentic biometric data, with robust fallback mechanisms to ensure system reliability.

Table of Contents
API Integration Architecture
Authentication and Authorization
Data Fetching Strategies
Error Handling and Fallbacks
Biomarker Analysis
AI-Powered Insights
Frontend Integration
Troubleshooting
API Integration Architecture
The biometric data integration uses a multi-layered approach:

UI Layer (JavaScript/AJAX)
      |
API Endpoint Layer (Flask Routes)
      |
Data Processing Layer (ring_routes.py)
      |
Data Acquisition Layer (ring_data.py)
      |
External APIs (Oura API, Ultrahuman API)
Key Files
ring_data.py: Handles API key management, direct API calls, and provides fallback mechanisms
ring_routes.py: Processes raw biometric data, analyzes patterns, and generates insights
static/js/ring_data.js: Manages frontend display and periodic data refresh
Authentication and Authorization
User Authorization
Only users with the email "huskyauto@gmail.com" (case-insensitive) are authorized to access ring data
The authorization check is implemented in RingDataManager._check_authorization() method
User model includes is_ring_data_authorized field to track authorization status
API Authentication
API keys for Oura Ring and Ultrahuman Ring are stored as environment variables:
OURA_API_KEY: Authentication token for Oura Ring API (v2)
ULTRAHUMAN_API_KEY: Authentication token for Ultrahuman Ring API (v1)
Data Fetching Strategies
Oura Ring API Integration
The implementation fetches multiple data points from the Oura Ring API v2:

Heart Rate Data: Uses /v2/usercollection/heartrate endpoint with time-based filtering

Retrieves recent heart rate measurements (past hour)
Extracts the latest BPM value
Daily Readiness Data: Uses /v2/usercollection/daily_readiness endpoint

Retrieves readiness score (used as stress level indicator)
Extracts HRV (Heart Rate Variability) data
Sleep Data: Uses /v2/usercollection/sleep endpoint

Retrieves temperature measurements
Uses data from yesterday if today's data isn't available
Ultrahuman Ring API Integration
The implementation uses redundant endpoints to maximize data availability:

Primary Strategy: Uses /api/v1/user/metrics/current endpoint

Fetches current day's metrics including recovery score, HRV, and temperature
Secondary Strategy: Uses /api/v1/user/dailyMetrics endpoint if primary fails

Gets daily aggregated metrics with different parameter names
Implements flexible field mapping to handle API variations
Tertiary Strategy: Uses /api/v1/user/health/latest endpoint as last resort

Gets the most recent health metrics regardless of date
Ensures data is always available if any endpoint works
Caching Strategy
Uses Python's @lru_cache decorator to cache responses (128 entries)
Reduces API call frequency and improves performance
Cache is cleared on demand via clear_cache() method
Error Handling and Fallbacks
Multi-Layered Error Management
API-Level Error Handling:

Specific exception handling for requests.exceptions.RequestException
Support for HTTP status code validation with response.raise_for_status()
Timeout configuration (10 seconds) to prevent blocking operations
Data Validation:

Null-safe data extraction using .get() method with default values
Empty response detection and appropriate error generation
Schema validation to ensure expected fields are present
Fallback Mechanism:

When API calls fail, realistic placeholder data is provided
Fallback data maintains system functionality during API outages
Error information is logged but not exposed to end users
Structured Error Responses
Error responses include:

Error flag to indicate failure state
Error message for debugging
Timestamp of the error
Default values for all expected metrics
Biomarker Analysis
Metric Calculation
Safe Average Calculation:

calculate_safe_average() function handles null values gracefully
Combines metrics from both rings when available
Safe Difference Calculation:

calculate_safe_difference() function for temperature delta calculations
Provides default values when one source is unavailable
Alert Generation
The system analyzes multiple biomarkers to detect health patterns:

Stress Level Analysis:

Three severity levels: warning, moderate, high
Thresholds: >60 (warning), >70 (moderate), >80 (high)
Heart Rate Variability (HRV) Analysis:

Cross-validates HRV from both devices
Three severity levels based on thresholds: <50 (warning), <45 (moderate), <35 (high)
Recovery Analysis:

Analyzes Ultrahuman's recovery index with thresholds: <75 (warning), <70 (moderate), <60 (high)
Provides context-specific recommendations based on severity
Temperature Variation Analysis:

Detects significant variations between sensors (>0.5Â°C)
Identifies potential measurement issues or health concerns
Cross-Metric Pattern Detection:

Detects correlations between stress and HRV
Identifies compound effects when multiple metrics show issues
AI-Powered Insights
OpenAI Integration
Uses OpenAI's GPT-4o-mini model for biomarker interpretation
API key stored in environment variable OPENAI_API_KEY
Robust error handling for API failures
Context Enhancement
The system enriches biometric data with:

Temporal context (time of day, circadian phase)
Alert information from the biomarker analysis
Historical context from past alerts
Safe handling of null or missing values
Insight Generation
The AI generates structured insights with:

Alert summary (current state overview)
Current state analysis (detailed metric interpretation)
Primary recommendations (immediate actions)
Secondary recommendations (preventive measures)
Monitoring focus (key metrics to watch)
Database Storage
Insights are stored in the BiomarkerInsight model
Includes metadata like timestamp, thresholds, and recommendations
Enables historical tracking of insight changes
Frontend Integration
Real-Time Updates
JavaScript polling mechanism refreshes data every 60 seconds
AJAX calls to /api/ring-data endpoint
Dynamic UI updates without page reload
Data Visualization
Immediate display of current biometric readings
Color-coded alerts based on severity
Expandable recommendations and insights
Responsive Design
Mobile-friendly interface for on-the-go monitoring
Adaptive layout based on available screen space
Accessibility considerations for all users
Troubleshooting
Common Issues
API Authentication Failures:

Verify API keys are correctly set in environment variables
Check API key expiration dates and rate limits
Confirm user has proper authorization in database
Data Discrepancies:

Cross-reference values between Oura and Ultrahuman
Check for timezone differences affecting data availability
Verify data freshness (timestamp values)
Missing Metrics:

Some metrics may be unavailable if user hasn't worn device
Sleep data may have a 24-hour delay from the API
HRV and recovery metrics require multiple nights of data
Logging and Debugging
Enhanced logging with DEBUG level for detailed diagnostics
[RING_DATA] prefix for easy log filtering
Separate logging for API call details and data processing
Performance Optimization
Connection pooling for efficient API requests
Request timeouts to prevent resource locking
Cache invalidation strategies to ensure fresh data
Implementation Notes
The current implementation successfully fetches real-time biometric data from both Oura Ring and Ultrahuman Ring APIs. The system combines data from both sources for comprehensive analysis and provides robust error handling to ensure continuous functionality even during API outages.

Future Enhancements
Advanced time-series analysis for trend detection
Personalized threshold adjustments based on historical data
Integration with additional biometric data sources
Machine learning models for predictive health insights
Expanded alert system with optional notifications